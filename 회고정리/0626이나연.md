# Thread ëª¨ë¸

![](https://velog.velcdn.com/images/leenayeonnn/post/5853f62e-dd6f-4669-bc11-5e7573215651/image.png)

<br/>

- ìš”ì²­ ì²˜ë¦¬

    - Spring BootëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ìš”ì²­ì„ í•˜ë‚˜ì˜ ì“°ë ˆë“œê°€ ì²˜ë¦¬í•˜ëŠ” êµ¬ì¡°
    - í´ë¼ì´ì–¸íŠ¸ë¡œ ë¶€í„° HTTP ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´, ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê°€ ì“°ë ˆë“œ í’€ì—ì„œ ì“°ë ˆë“œ í• ë‹¹í•´ ìš”ì²­ ì²˜ë¦¬
    
- ë¹„ë™ê¸° ì²˜ë¦¬

    - Spring Boot ëŠ” ë¹„ë™ê¸° ìš”ì²­ ì²˜ë¦¬ ì§€ì›í•¨
    - ë¹„ë™ê¸° ì²˜ë¦¬ëŠ” ë³„ë„ì˜ ë¹„ë™ê¸° ì‘ì—… ì“°ë ˆë“œ í’€ ì‚¬ìš©
    
<br/>

## ê¸°ë³¸ ì“°ë ˆë“œ ìˆ˜

- maxThreads = ë™ì‹œ ìš”ì²­ ìµœëŒ€ ì“°ë ˆë“œ ìˆ˜ = 200
- minSpareThreads = ìµœì†Œ ì—¬ìœ  ì“°ë ˆë“œ ìˆ˜ = ì´ˆê¸°í™”ì‹œ ê¸°ë³¸ ì“°ë ˆë“œ ìˆ˜ = 10
- acceptCount = ìµœëŒ€ ëŒ€ê¸° ìš”ì²­ ìˆ˜ = 100

<br/>

---

# ThreadLocal
> íŠ¹ì • ì“°ë ˆë“œì— ë°”ì¸ë”©ëœ ë³€ìˆ˜ë¥¼ ì €ì¥í•˜ê³  ì½ì„ ìˆ˜ ìˆëŠ” ë©”ì»¤ë‹ˆì¦˜ ì œê³µ
> í•˜ë‚˜ì˜ ì“°ë ˆë“œì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ ë³€ìˆ˜ë¥¼ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë„ì›€
> Spring Boot Web Applicationì—ì„œ ìš”ì²­ ì²˜ë¦¬ ë™ì•ˆ ì •ë³´ ìœ ì§€ ë° ê³µìœ í•˜ëŠ”ë° ì‚¬ìš©

<br/>

## ê¸°ë³¸ ê°œë…

- ThreadLocal í´ë˜ìŠ¤

    - ê° ì“°ë ˆë“œê°€ ê³ ìœ í•œ ê°’ì„ ê°€ì§ˆ ìˆ˜ ìˆê²Œí•¨
    - ì“°ë ˆë“œê°€ í•´ë‹¹ ë³€ìˆ˜ë¥¼ ì½ê±°ë‚˜ ì“¸ëŒ€, ThreadLocalì€ ê·¸ ì“°ë ˆë“œë§Œì„ ìœ„í•œ ê³ ìœ  ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜
    
- ë™ì‘ ì›ë¦¬

    - ê° ì“°ë ˆë“œëŠ” ThreadLocal ê°ì²´ì— ëŒ€í•´ ë…ë¦½ì ì¸ ê°’ì„ ê°€ì§
    - ë”°ë¼ì„œ, í•œ ì“°ë ˆë“œê°€ ThreadLocalì— ê°’ì„ ì €ì¥í•˜ë©´ ë‹¤ë¥¸ ì“°ë ˆë“œëŠ” í•´ë‹¹ ê°’ì„ ë³¼ ìˆ˜ ì—†ìŒ
    
<br/>

## ì½”ë“œ

```java
public class UserContext {
    private static final ThreadLocal<User> USER_THREAD_LOCAL = ThreadLocal.withInitial(() -> null);

    public static void setUser(User user) {
        USER_THREAD_LOCAL.set(user);
    }

    public static User getUser() {
        return USER_THREAD_LOCAL.get();
    }

    public static void clear() {
        USER_THREAD_LOCAL.remove();
    }
}

```

<br/>

### clear() í•¨ìˆ˜ê°€ ìˆì–´ì•¼ í•˜ëŠ” ì´ìœ ?
> ê° ìš”ì²­ë§ˆë‹¤ Thread Pool ì—ì„œ ì“°ë ˆë“œê°€ í• ë‹¹ë˜ì„œ ì‚¬ìš©ë¨
> ì´í›„, ìš”ì²­ì´ ëë‚˜ë©´ í•´ë‹¹ ì“°ë ˆë“œëŠ” ë°˜í™˜ë˜ê³  ë‹¤ë¥¸ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë¨
> ì´ë•Œ, ë‚´ë¶€ ì •ë³´ë¥¼ ì§€ì›Œì£¼ì§€ ì•Šìœ¼ë©´ ë‹¤ë¥¸ ìš”ì²­ì—ì„œ í•´ë‹¹ ê°’ì„ ê°€ì ¸ê°€ê¸° ë•Œë¬¸!!

<br/>

---
# Filter
> Spring ì—ì„œ ê³µí†µ ì‘ì—…ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ ì¤‘ í•˜ë‚˜
> DispatcherServlet í˜¸ì¶œ ì „/í›„ ì— urlì— ë§ê²Œ ê³µí†µ ì‘ì—… ìˆ˜í–‰ í•  ìˆ˜ ìˆê²Œ í•¨


<p align="center"><img src="https://velog.velcdn.com/images/leenayeonnn/post/def7352d-de62-4074-99a7-92fefe38fcf3/image.png" width="70%" height="70%"></p>

<br/>

## Filter ë©”ì„œë“œ

- init()

    - í†°ìº£ì´ ì‹œì‘ë  ë•Œ(ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™” ì‹œ) ìµœì´ˆ í•œ ë²ˆ ìˆ˜í–‰
    - Filterê°€ ì²˜ë¦¬í•´ì•¼ í•  ì´ˆê¸°í™” ì‘ì—… ìˆ˜í–‰
    
- doFilter()
	
    - HTTP ìš”ì²­ ë° ì‘ë‹µ ì²˜ë¦¬ì˜ í•µì‹¬ ë¡œì§ ìˆ˜í–‰
    - ìš”ì²­ ë° ì‘ë‹µì„ ê°€ê³µí•˜ê±°ë‚˜ ë³€ê²½í•˜ëŠ” ì‘ì—… ìˆ˜í–‰
    - FilterChain.doFilter() ë©”ì„œë“œë¥¼ í†µí•´ ë‹¤ìŒ ëŒ€ìƒìœ¼ë¡œ ìš”ì²­ ì „ë‹¬
    	
        - ì¶”ê°€ í•„í„°ê°€ ë” ìˆìœ¼ë©´ í•„í„°ë¥¼ ê³„ì† ê±°ì¹˜ê²Œ í•˜ê³ 
        - ì¶”ê°€ í•„í„°ê°€ ë” ì—†ìœ¼ë©´ DispatcherServeltìœ¼ë¡œ ë„˜ì–´ê°
        
- destroy()

    - Filter ì¸ìŠ¤í„´ìŠ¤ê°€ ì†Œë©¸ë  ë•Œ í˜¸ì¶œ
    - ìì› ì •ë¦¬ ë° í•´ì œ ì‘ì—… ìˆ˜í–‰

<br/>


```java
public class FirstFilter implements Filter {
    public FirstFilter() {
        log.info("=== first filter constructor () run ===");
    }

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        log.info("=== first filter init () run ===");
    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)
            throws IOException, ServletException {
        log.info("=== first filter doFilter () run ===");

        filterChain.doFilter(servletRequest, servletResponse);

        log.info("=== first filter doFilter () end ===");

    }

    @Override
    public void destroy() {
        log.info("=== first filter destroy () run ===");
    }
}
```

<br/>

---

# Filter Bean ë“±ë¡ ë°©ë²•

<br/>

## Config - ì¶”ì²œğŸ‘

```java
@Configuration
public class FilterConfig {
    @Bean
    public FilterRegistrationBean<FirstFilter> firstFilter() {
        FilterRegistrationBean<FirstFilter> registrationBean = new FilterRegistrationBean<>();
        FirstFilter firstFilter = new FirstFilter();
        registrationBean.setFilter(firstFilter);
        registrationBean.addUrlPatterns("/*");
        registrationBean.setOrder(1);
        return registrationBean;
    }
}
```

<br/>

- FilterRegistrationBean

    - Filterë¥¼ Beanìœ¼ë¡œ ë“±ë¡í•˜ê¸° ìœ„í•œ class
    
- setFilter(Filter)

    - ì„¤ì •í•  Filterë¥¼ ì§€ì •
    
- addUrlPatterns(String)
	
    - í•´ë‹¹ í•„í„°ë¥¼ ì ìš©í•  ë²”ìœ„ ì§€ì •
    
- setOrder(int)
	
    - í•´ë‹¹ í•„í„°ì˜ ìš°ì„ ìˆœìœ„ ì§€ì •
    - ë‚®ì„ ìˆ˜ë¡ ë†’ì€ ìš°ì„ ìˆœìœ„
    
<br/>

## @Component

```java
@Component
@Order(1)
public class FirstFilter implements Filter {
    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)
            throws IOException, ServletException {
        log.info("=== first filter doFilter () run ===");

        filterChain.doFilter(servletRequest, servletResponse);

        log.info("=== first filter doFilter () end ===");

    }
}
```

<br/>

- ì„¤ì • íŒŒì¼ì„ ë§Œë“¤ì§€ ì•Šê³  ë¹ˆ ë“±ë¡ ê°€ëŠ¥
- `@Order` ë¥¼ í†µí•´ ìˆœì„œ ì§€ì • ê°€ëŠ¥
- ê¸°ë³¸ URL ì„¤ì • = `/*`

    - ë³€ê²½ ë¶ˆê°€
    
<br/>

## @WebFilter + @ServletComponentScan

```java
@WebFilter
public class FirstFilter implements Filter {
    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)
            throws IOException, ServletException {
        log.info("=== first filter doFilter () run ===");

        filterChain.doFilter(servletRequest, servletResponse);

        log.info("=== first filter doFilter () end ===");

    }
}
```

```java
@SpringBootApplication
@ServletComponentScan
public class FilterExamApplication {

    public static void main(String[] args) {
        SpringApplication.run(FilterExamApplication.class, args);
    }

}

```

<br/>

- ì„¤ì • íŒŒì¼ì„ ë§Œë“¤ì§€ ì•Šê³  ë¹ˆ ë“±ë¡ ê°€ëŠ¥
- Application ë©”ì¸ì— `@ServletComponentScan` ì‘ì„± í•„ìˆ˜
- `@Order` ë¥¼ í†µí•´ ìˆœì„œ ì§€ì • ë¶ˆê°€
- `@WebFilter` ì´ìš©í•´ì„œ URL ë²”ìœ„ ì§€ì • ê°€ëŠ¥
    
<br/>

## ì‚¬ìš© ì£¼ì˜ ì¡°í•© - @Component + @WebFilter
>`@Component` ë¡œ ë¹ˆ ë“±ë¡ + `@WebFilter` ë¡œ URL ì§€ì •í•˜ë©´ ê°€ëŠ¥í•˜ì§€ ì•Šì„ê¹Œ?

<br/>

- `@Component`

    - `@SpringBootApplication` ë‚´ë¶€ì˜ `@Component`ê³¼ ë§Œë‚˜ë©´ì„œ ìë™ ë¹ˆ ë“±ë¡
    - ì´ë•Œ, `@Component` ëŠ” ê¸°ë³¸ URLì´ `/*` ì´ê¸°ì— ì „ì²´ URLì— ëŒ€í•´ í•„í„° ì ìš©ë¨
    
- `@WebFilter`

    - `@ServletComponentScan` ì´ ì—†ìœ¼ë©´ ë“±ë¡ X
    - `@ServletComponentScan` ì´ ìˆìœ¼ë©´ ì„¤ì • URLì„ ë² ì´ìŠ¤ë¡œ í•„í„° ì ìš©
    
<br/>

> [!note] ê²°ë¡ 
> ì´ì¤‘ìœ¼ë¡œ ë¹ˆì´ ë“±ë¡ë˜ì–´ì„œ URL ì§€ì •í•œ ì˜ë¯¸ê°€ ì—†ì–´ì§
> ê·¸ëƒ¥ Filterë§Œ 2ë²ˆ ê±°ì¹˜ê²Œ ë¨

<br/>

---
# Filter + Cookie ì´ìš©í•œ ê°„ë‹¨ ë¡œê·¸ì¸

<br/>

## ë¡œì§

- 1 : Controller

    - ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì‹œ ì¿ í‚¤ ë°œí–‰

- 2 : Filter

    - í•„í„°ì—ì„œ ì¿ í‚¤ ë°›ì•„ì™€ì„œ ì¿ í‚¤ ì •ë³´ í™•ì¸
    - ì¿ í‚¤ ì •ë³´ í™•ì¸ë˜ë©´ ThreadLocalì— ì €ì¥
    
- 3 : Controller

    - ë¹„íšŒì› ì ‘ê·¼ ê¸ˆì§€ URLì— ëŒ€í•´ì„œ
    - ThreadLocalì— ì €ì¥ëœ ê°’ í™•ì¸
    - ë¹„íšŒì› ì‹œ ë¡œê·¸ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    - íšŒì› ì‹œ í˜ì´ì§€ë¡œ ì´ë™
    
<br/>

### ë¡œê·¸ì•„ì›ƒ ì‹œ ì¿ í‚¤ë¥¼ ë°œí–‰í•˜ëŠ” ì´ìœ 
> ì„œë²„ì—ì„œ ì¿ í‚¤ë¥¼ ì§€ì›Œë„ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¿ í‚¤ê°€ ë‚¨ì•„ìˆìŒ
> ë”°ë¼ì„œ ê°™ì€ ì´ë¦„ì˜ ì¿ í‚¤ë¥¼ ë°œê¸‰í•´ ë®ì–´ì”Œì–´ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì—†ì• ì¤Œ

---

ì°¸ê³ 
https://m.blog.naver.com/fbfbf1/223021249026
https://linked2ev.github.io/gitlog/2019/09/15/springboot-mvc-13-%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-MVC-Filter-%EC%84%A4%EC%A0%95/
https://velog.io/@woo00oo/SpringBoot-Filter%ED%95%84%ED%84%B0
https://velog.io/@ksk7584/Filter%EB%A5%BC-%EB%93%B1%EB%A1%9D%ED%95%98%EB%8A%94-4%EA%B0%80%EC%A7%80-%EB%B0%A9%EB%B2%95#component
https://taetaetae.github.io/2020/04/06/spring-boot-filter/